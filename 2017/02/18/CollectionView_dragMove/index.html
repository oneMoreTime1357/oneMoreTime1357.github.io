<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CollectionView 拖拽移动 · MissYang</title><meta name="description" content="CollectionView 拖拽移动 - 杨小丹"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yikeshu.info/atom.xml" title="MissYang"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon-logo.png" alt="logo"><span>杨小丹</span></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/oneMoreTime1357" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">CollectionView 拖拽移动</h1><div class="post-info">Feb 18, 2017</div><div class="post-content"><h3 id="iOS9新特性，collectionView的退拽"><a href="#iOS9新特性，collectionView的退拽" class="headerlink" title="iOS9新特性，collectionView的退拽"></a>iOS9新特性，collectionView的退拽</h3><ul>
<li>创建collectionView，实现代理方法和Datasource，向collectionView 添加长按事件，如下这是我创建collectionView，注册的cell。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UICollectionView</span> *)collectionView &#123;</span><br><span class="line">	<span class="keyword">if</span>(_collectionView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="built_in">UICollectionViewFlowLayout</span> *flowLayout = [[<span class="built_in">UICollectionViewFlowLayout</span> alloc] init];</span><br><span class="line">        flowLayout.itemSize = <span class="built_in">CGSizeMake</span>(<span class="number">45</span>, <span class="number">45</span>);</span><br><span class="line">        flowLayout.minimumLineSpacing = <span class="number">10</span>;</span><br><span class="line">        flowLayout.minimumInteritemSpacing = <span class="number">10</span>;</span><br><span class="line">        flowLayout.sectionInset = <span class="built_in">UIEdgeInsetsMake</span>(<span class="number">15</span>, <span class="number">15</span>, <span class="number">15</span>, <span class="number">15</span>);</span><br><span class="line">        _collectionView = [[<span class="built_in">UICollectionView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, KScreenWidth, KScreenHeight) collectionViewLayout:flowLayout];</span><br><span class="line">        _collectionView.delegate = <span class="keyword">self</span>;</span><br><span class="line">        _collectionView.dataSource = <span class="keyword">self</span>;</span><br><span class="line">        _collectionView.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">        [_collectionView registerClass:[MoveCollectionViewCell <span class="keyword">class</span>] forCellWithReuseIdentifier:identity];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">UILongPressGestureRecognizer</span> *longPressGesture = [[<span class="built_in">UILongPressGestureRecognizer</span> alloc] initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(longPressAction:)];</span><br><span class="line">        [_collectionView addGestureRecognizer:longPressGesture];</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">return</span> _collectionView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>实现datasource ，加入数据源，</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSInteger</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView numberOfItemsInSection:(<span class="built_in">NSInteger</span>)section &#123;</span><br><span class="line">    <span class="keyword">return</span> _data.count;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line">- (<span class="built_in">UICollectionViewCell</span> *)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView cellForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    MoveCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:identity forIndexPath:indexPath];</span><br><span class="line">    cell.img = _data[indexPath.row];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>下面使用iOS9的新特性实现拖拽，必须实现下面的方法<a id="more"></a></li>
<li>开始移动的时候调用此方法，可以获取相应的datasource方法设置特殊的indexpath 能否移动,如果能移动返回的是YES ,不能移动返回的是NO</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)beginInteractiveMovementForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br></pre></td></tr></table></figure>
<ul>
<li>更新移动过程的位置</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)updateInteractiveMovementTargetPosition:(<span class="built_in">CGPoint</span>)targetPosition</span><br></pre></td></tr></table></figure>
<ul>
<li>结束移动的时候调用此方法，collectionView 会响应相应的datasource方法，collectionView:moveItemAtIndexPath:toIndexPath:  我们可以在这个方法中将移动的数据源，与目标数据源交互位置。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)endInteractiveMovement</span><br></pre></td></tr></table></figure>
<ul>
<li>取消移动的时候调用，会返回最原始的位置。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)cancelInteractiveMovement;</span><br></pre></td></tr></table></figure>
<ul>
<li>在开始移动的时候会调用这个方法，如果有特殊的单元格不想被移动可以return NO， 如果没有限制就返回YES 吧。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView canMoveItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明            </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">collectionView</td>
<td style="text-align:left">调用这个代理方法的 collection View</td>
</tr>
<tr>
<td style="text-align:left">indexPath</td>
<td style="text-align:left">collectionView 中想要移动的 indexpath</td>
</tr>
</tbody>
</table>
<ul>
<li>移动结束的时候会调用此datasource，想要拖拽完成之后数据正确必须实现此方法，使用新的路径更新数据源，如果不实现此方法，刚刚移动cell中的数据不会重新排列。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView moveItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)sourceIndexPath</span><br><span class="line">           toIndexPath:(<span class="built_in">NSIndexPath</span> *)destinationIndexPath</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明            </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">collectionView</td>
<td style="text-align:left">正在响应这个方法的collectionView</td>
</tr>
<tr>
<td style="text-align:left">sourceIndexPath</td>
<td style="text-align:left">原始移动的indexpath</td>
</tr>
<tr>
<td style="text-align:left">destinationIndexPath</td>
<td style="text-align:left">移动到目标位置的indexpath</td>
</tr>
</tbody>
</table>
<ul>
<li>刚刚我们已经给collectionView 添加了长按的手势，目的就是长按的时候，可以拖动cell来进行移动，那怎么开始移动呢？我们来实现长按事件看看。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)longPressAction:(<span class="built_in">UILongPressGestureRecognizer</span> *)longPress &#123;</span><br><span class="line">    <span class="comment">//获取此次点击的坐标，根据坐标获取cell对应的indexPath</span></span><br><span class="line">    <span class="built_in">CGPoint</span> point = [longPress locationInView:_collectionView];</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *indexPath = [<span class="keyword">self</span>.collectionView indexPathForItemAtPoint:point];</span><br><span class="line">    <span class="comment">//根据长按手势的状态进行处理。</span></span><br><span class="line">    <span class="keyword">switch</span> (longPress.state) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateBegan</span>:</span><br><span class="line">            <span class="comment">//当没有点击到cell的时候不进行处理</span></span><br><span class="line">            <span class="keyword">if</span> (!indexPath) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//开始移动</span></span><br><span class="line">            [_collectionView beginInteractiveMovementForItemAtIndexPath:indexPath];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateChanged</span>:</span><br><span class="line">        <span class="comment">//移动过程中更新位置坐标</span></span><br><span class="line">            [_collectionView updateInteractiveMovementTargetPosition:point];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateEnded</span>:</span><br><span class="line">        <span class="comment">//停止移动调用此方法</span></span><br><span class="line">            [_collectionView endInteractiveMovement];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">//取消移动</span></span><br><span class="line">            [_collectionView cancelInteractiveMovement];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>下面这两个方法都需要实现。<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在开始移动时会调用此代理方法，</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView canMoveItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    	<span class="comment">//根据indexpath判断单元格是否可以移动，如果都可以移动，直接就返回YES ,不能移动的返回NO</span></span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在移动结束的时候调用此代理方法</span></span><br><span class="line">- (<span class="keyword">void</span>)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView moveItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)sourceIndexPath toIndexPath:(<span class="built_in">NSIndexPath</span>*)destinationIndexPath &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *sourceIndexPath 原始数据 indexpath</span></span><br><span class="line"><span class="comment">     * destinationIndexPath 移动到目标数据的 indexPath</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    [_data removeObjectAtIndex:sourceIndexPath.row];</span><br><span class="line">    <span class="built_in">UIImage</span> *img = _data[sourceIndexPath.row]</span><br><span class="line">    [_data insertObject:img atIndex:destinationIndexPath.row];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="自己写collectionView拖拽的方法"><a href="#自己写collectionView拖拽的方法" class="headerlink" title="自己写collectionView拖拽的方法"></a>自己写collectionView拖拽的方法</h3><ul>
<li><p>如果你的手机支持iOS9或更高版本，使用苹果为我们提供的方法实现拖拽功能是没有问题的。相信还有很多都在支持ios8，所以下面的方法也许很适用。</p>
<ul>
<li><p>在<strong>- (UICollectionViewCell <em>)collectionView:(UICollectionView </em>)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath</strong> 方法中，为每个cell添加长按手势，这样就可以在你长按cell的时候响应事件。</p>
</li>
<li><p>下面我们看看长按事件中应该实现怎样的方法。</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)longPressAction:(<span class="built_in">UILongPressGestureRecognizer</span> *)longPress &#123;</span><br><span class="line">   	<span class="comment">//获取当前cell所对应的indexpath </span></span><br><span class="line">   	MoveCollectionViewCell *cell = (MoveCollectionViewCell *)longPress.view;</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *cellIndexpath = [_collectionView indexPathForCell:cell];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将此cell 移动到视图的前面</span></span><br><span class="line">    [_collectionView bringSubviewToFront:cell];</span><br><span class="line">    _isChange = <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (longPress.state) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateBegan</span>: &#123;</span><br><span class="line">        <span class="comment">//使用数组将collectionView每个cell的 UICollectionViewLayoutAttributes 存储起来。</span></span><br><span class="line">            [<span class="keyword">self</span>.cellAttributesArray removeAllObjects];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">self</span>.data.count; i++) &#123;</span><br><span class="line">                [<span class="keyword">self</span>.cellAttributesArray addObject:[_collectionView layoutAttributesForItemAtIndexPath:[<span class="built_in">NSIndexPath</span> indexPathForRow:i inSection:<span class="number">0</span>]]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateChanged</span>: &#123;</span><br><span class="line">            <span class="comment">//在移动过程中，使cell的中心与移动的位置相同。</span></span><br><span class="line">            cell.center = [longPress locationInView:_collectionView];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">UICollectionViewLayoutAttributes</span> *attributes <span class="keyword">in</span> <span class="keyword">self</span>.cellAttributesArray) &#123;</span><br><span class="line">            <span class="comment">//判断移动cell的indexpath，是否和目的位置相同，如果相同isChange为YES,然后将数据源交换</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">CGRectContainsPoint</span>(attributes.frame, cell.center) &amp;&amp; cellIndexpath != attributes.indexPath) &#123;</span><br><span class="line">                    _isChange = <span class="literal">YES</span>;</span><br><span class="line">                    <span class="built_in">NSString</span> *imgStr = <span class="keyword">self</span>.data[cellIndexpath.row];</span><br><span class="line">                    [<span class="keyword">self</span>.data removeObjectAtIndex:cellIndexpath.row];</span><br><span class="line">                    [<span class="keyword">self</span>.data insertObject:imgStr atIndex:attributes.indexPath.row];</span><br><span class="line">                    [<span class="keyword">self</span>.collectionView moveItemAtIndexPath:cellIndexpath toIndexPath:attributes.indexPath];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateEnded</span>: &#123;</span><br><span class="line">            <span class="comment">//如果没有改变，直接返回原始位置</span></span><br><span class="line">            <span class="keyword">if</span> (!_isChange) &#123;</span><br><span class="line">                cell.center = [_collectionView layoutAttributesForItemAtIndexPath:cellIndexpath].center;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 不使用iOS9的代理方法，实现拖拽移动也很简单,可以试试。<br> 代码已经放到github仓库请点击这里 <strong><a href="https://github.com/oneMoreTime1357/CollectionViewTips" target="_blank" rel="noopener">项目链接</a></strong> 查看</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/18/nsuserdefaults/" class="prev">PREV</a></div><div data-thread-key="2017/02/18/CollectionView_dragMove/" data-title="CollectionView 拖拽移动" data-url="http://yikeshu.info/2017/02/18/CollectionView_dragMove/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"6280987357357278000"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2017 - 2018 <a href="http://yikeshu.info">杨小丹</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>